<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Week 8: Chapter 12</title>
        <script type="text/javascript" src="https://d3js.org/d3.v3.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
		<script src="http://ajax.googleapis.com/ajax/libs/prototype/1.6.0.2/prototype.js"></script>
		<style type="text/css">
			#tooltip {
				position: absolute;
				width: 200px;
				height: auto;
				padding: 10px;
				background-color: white;
				-webkit-border-radius: 10px;
				-moz-border-radius: 10px;
				border-radius: 10px;
				-webkit-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
				-moz-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
				box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
				pointer-events: none;
			}

			#descriptionText {
				display:inline

			}
			#description {
				display:inline

			}
		</style>
    </head>
	
	<h2><em>Assignment 2B: </em> Visualizing geodata using D3.js</h2>
	<p>Click a button to see visualizations of the K-mean results.
	   The default view is for K = 3. Hover over buttons for preview.
	</p>

	<p id="description">You are now visualizing: </p>
	<p id="descriptionText" class="descriptionText" onchange="descriptionText(this);"></p>
	
	    <!--Buttons for switching between the different k-values-->
		<div id="k2">
			<input name="k2btn"
				type="button"
				value="K = 2"
				style="float:left"></input>
		</div>
		<div id="k3">
			<input name="k3btn"
				type="button"
				value="K = 3"
				style="float:left"></input>
		</div>
		<div id="k4">
			<input name="k4btn"
				type="button"
				value="K = 4"
				style="float:left"></input>
		</div>
		<div id="k5">
			<input name="k5btn"
				type="button"
				value="K = 5"
				style="float:left"></input>
		</div>
		<div id="k6">
			<input name="k6btn"
				type="button"
				value="K = 6"
				style="float:left"></input>
		</div>
	
    <body>
	<script type="text/javascript">

			d3.selection.prototype.moveToFront = function() {
					return this.each(function(){
						this.parentNode.appendChild(this);
					});
				};	
			d3.selection.prototype.moveToBack = function() { 
    				return this.each(function() { 
       				var firstChild = this.parentNode; 
        			if (firstChild) { 
            			this.parentNode.insertBefore(this, firstChild); 
        			} 
    			}); 
			};		

			//Reading the datafiles once and for all
			var mean_file_k2 = "data/k_mean_files/k2_means.csv";
			var data_file_k2 = "data/data_files/Data_k2.csv";
			var mean_file_k3 = "data/k_mean_files/k3_means.csv";
			var data_file_k3 = "data/data_files/Data_k3.csv";
			var mean_file_k4 = "data/k_mean_files/k4_means.csv";
			var data_file_k4 = "data/data_files/Data_k4.csv";
			var mean_file_k5 = "data/k_mean_files/k5_means.csv";
			var data_file_k5 = "data/data_files/Data_k5.csv";
			var mean_file_k6 = "data/k_mean_files/k6_means.csv";
			var data_file_k6 = "data/data_files/Data_k6.csv";

			var dis_path = "data/data_files/dis_cent.csv";
			var dis_name = [];
			var x_cent = [];
			var y_cent = [];

			var names = [];
			var coordinates = [];
			var centroids_2x = [];
			var centroids_2y = [];
			
			//Width and height
			var w = 600;
			var h = 600;
			//Define map projection
			var projection = d3.geo.mercator()
								   .center([-122.433701, 37.767683]) //Center at SF
								   .translate([w / 2, h / 2])
								   .scale([180000]); //We add a significant amount of scaling here because the mercator projection 
								   					 // is a projection of the entire world, then center it on SF and zoom in (scale)
			//Define path generator
			var path = d3.geo.path()
							 .projection(projection);

			var color = d3.scale.quantize()
								.range(['rgb(255,245,240)','rgb(254,224,210)','rgb(252,187,161)','rgb(252,146,114)','rgb(251,106,74)','rgb(239,59,44)','rgb(203,24,29)','rgb(165,15,21)','rgb(103,0,13)'])
								//.range(["rgb(237,248,233)","rgb(186,228,179)","rgb(116,196,118)","rgb(49,163,84)","rgb(0,109,44)"]);
								//Colors taken from colorbrewer.js, included in the D3 download
							 
			//Create SVG element
			var svg = d3.select("body")
						.append("svg")
						.attr("width", w)
						.attr("height", h);

			//Load in count of prostitution crime
			d3.csv("data/data_files/total_prost.csv", function(data) {

				//Set input domain for color scale
				color.domain([
					d3.min(data, function(d) { return d.Count; }), 
					d3.max(data, function(d) { return d.Count; })
				]);

			//Load in GeoJSON data
			d3.json("data/data_files/sfpddistricts.json", function(json) {	

				    //Merge the ag. data and GeoJSON
					//Loop through once for each ag. data value
					for (var i = 0; i < data.length; i++) {
				
						//Grab state name
						var dataState = data[i].District;
						
						//Grab data value, and convert from string to float
						var dataValue = parseFloat(data[i].Count);
				
						//Find the corresponding state inside the GeoJSON
						for (var j = 0; j < json.features.length; j++) {
						
							var jsonState = json.features[j].properties.DISTRICT;
				
							if (dataState == jsonState) {
						
								//Copy the data value into the JSON
								json.features[j].properties.Count = dataValue;
								
								//Stop looking through the JSON
								break;
								
							}
						}		
					}

					//Bind data and create one path per GeoJSON feature
					svg.selectAll("path")
					   .data(json.features)
					   .enter()
					   .append("path")
					   .attr("d", path)
					   .style("fill", function(d) {
					   		//Get data value
					   		var value = d.properties.Count;
					   		console.log(value)
					   		
					   		if (value) {
					   			//If value exists…
						   		return color(value);
					   		} else {
					   			//If value is undefined…
						   		return "#ccc";
					   		}
					   })
					   .style("opacity", "0.9")
					   .style("stroke", "black")
					   .style("stroke-width", "1.5px")
					   .style("stroke-opacity", "0.6");
			
				addDataToMap(json);	
				var current_coord = [];
				});
			});

			//Adding data from the datafiles to the map	
			function addDataToMap(json){
			//Bind data and create one path per GeoJSON feature
			  d3.selectAll("path")
			  	.each(function (d, i) {
     				var centroid = path.centroid(d);
     				centroids_2x.push(centroid[0])
     				centroids_2y.push(centroid[1])
  				});

				labels_add();

				function call_obs(){		
					d3.csv(data_file_k3, function(data_csv){			
						addObs(data_csv)
					});
				}

				d3.csv(mean_file_k3, function(mean_csv){			
					addMeans(mean_csv)
					call_obs();
				});	

				//Adding observations
				function addObs(data_csv) {
		   		     svg.selectAll("dot")
						.data(data_csv)
						.enter()
				        .append("circle")
						.attr("id", "obs")
						.attr("cx", function(d) {
							return projection([d.X_input, d.Y_input])[0];
						})
						.attr("cy", function(d) {
							return projection([d.X_input, d.Y_input])[1];
						})
						.attr("r", "1.5")
						.style("fill", function(d) {
								if(d.Label == 0) {
									return "rgb(0, 0, 200)";
								}
								else if(d.Label == 1) {
									return "rgb(0, 200, 0)";
								}
								else if(d.Label == 2) {
									return "rgb(200, 0, 0)";
								}
						})
						.style("opacity", "0.8")
						.attr("stroke", "grey")
						.attr("stroke-width", "0.2")
					 d3.selectAll('#mean').moveToFront()					
				}						
				
				//Adding means
				function addMeans(mean_csv) {
		 			 svg.selectAll("circle")
						.data(mean_csv)
						.enter()
				  	    .append("circle")
						.attr("id", "mean")
						.attr("cx", function(d) {
							return projection([d.lon, d.lat])[0];
						})
						.attr("cy", function(d) {
							return projection([d.lon, d.lat])[1];
						})
						.attr("r", "8")
						.style("stroke", "black")
						.attr("stroke-width", "1.5")
						.style("fill", function(d) {
								if(d.Label == 0) {
									return "rgb(0, 0, 200)";
								}
								else if(d.Label == 1) {
									return "rgb(0, 200, 0)";
								}
								else if(d.Label == 2) {
									return "rgb(200, 0, 0)";
								}
						})						
				}				
			};


			function labels_add(){
				d3.csv(dis_path, function(data){
					data.map(function(d){
						dis_name.push(d.District)
						x_cent.push(d.X)
						y_cent.push(d.Y)
					})
					var labels = svg.selectAll("text")
									.data(dis_name)
									.enter()
									.append("text") 
									.attr("id", "lab")
									.text(function(d) {
										return d;
									})
									.attr("x", function(d,i) {
										return centroids_2x[i]-28;
									})
									.attr("y", function(d, i) {
										return centroids_2y[i]+15;
									})
									.attr("font-family", "sans-serif")
									.attr("font-size", "14px")
									.attr("fill", "black")
									.attr("stroke", "grey")
									.attr("stroke-width", "0.2px")
									.attr("font-weight", "bold")
									.attr("opacity", "0.9")
									.on("mouseover", function() { 
										d3.select(this)
											.transition()
											.duration(50)
											.ease("linear")
											.attr("font-size", "22px")
											.attr("opacity", "0.7");
										d3.select(this).moveToFront();
									})
									.on("mouseout", function() { 
										d3.select(this)							
											.transition()
											.duration(5)
											.ease("linear")
											.attr("font-size", "14px")
											.attr("opacity", "0.9")
										d3.select(this).moveToBack();
									});
					//console.log(labels);

				});	

			}
		d3.selectAll('#lab').moveToFront();
		//On click, update with new data			
		d3.selectAll("div")
			.on("click", function() {
			var divID = d3.select(this).attr("id");
			
				var descriptionText = document.getElementById('descriptionText');

				if (divID == "k2") {
					var mean_file = mean_file_k2;
					var data_file = data_file_k2;
					descriptionText.innerHTML = "K = 2"
				}
				else if (divID == "k3") {
					var mean_file = mean_file_k3;
					var data_file = data_file_k3;
					descriptionText.innerHTML = "K = 3"
				}
				else if (divID == "k4") {
					var mean_file = mean_file_k4;
					var data_file = data_file_k4;
					descriptionText.innerHTML = "K = 4"
				}
				else if (divID == "k5") {
					var mean_file = mean_file_k5;
					var data_file = data_file_k5;
					descriptionText.innerHTML = "K = 5"
				}
				else if (divID == "k6") {
					var mean_file = mean_file_k6;
					var data_file = data_file_k6;
					descriptionText.innerHTML = "K = 6"
				};
				
				function call_obs(){
					//Add dots for the observations
					d3.csv(data_file, function(data_csv	){
						addObs(data_csv);
					});		
				}
				//Add circles for the K means
				d3.csv(mean_file, function(mean_csv){
					addMeans(mean_csv);	
					call_obs();
				});							
				
				function addMeans(mean_csv){
					var circles = svg.selectAll("circle")	//Select all circles
						.data(mean_csv) 					//Re-bind data to existing circles, return the 'update' selection
				 circles.transition()
						.ease("circle")
						.duration(2000)
						.attr("id", "mean")
						.attr("cx", function(d) {
							return projection([d.lon, d.lat])[0];
						})
						.attr("cy", function(d) {
							return projection([d.lon, d.lat])[1];
						})
						.attr("r", "8")
						.style("stroke", "black")
						.attr("stroke-width", "2.5")
						.style("fill", function(d) {
								if(d.Label == 0) {
									return "rgb(0, 0, 200)";
								}
								else if(d.Label == 1) {
									return "rgb(0, 200, 0)";
								}
								else if(d.Label == 2) {
									return "rgb(200, 0, 0)";
								}
								else if(d.Label == 3) {
									return "rgb(200, 200, 0)";
								}
								else if(d.Label == 4) {
									return "rgb(200, 0, 200)";
								}
								else if(d.Label == 5) {
									return "rgb(0, 200, 200)";
								}					
						})
						.style("opacity", 1)					
				 circles.exit()
						.remove();
				}		

				function addObs(data_csv){
					var dots = svg.selectAll("dot")	//Select all dots
						.data(data_csv); 				//Re-bind data to existing dots, return the 'update' selection
					dots.enter()						
						.append("circle")
						.attr("id", "obs")
						.attr("cx", function(d) {
							return projection([d.X_input, d.Y_input])[0];
						})
						.attr("cy", function(d) {
							return projection([d.X_input, d.Y_input])[1];
						})
						.attr("r", "1.5")
						.style("fill", function(d) {
								if(d.Label == 0) {
									return "rgb(0, 0, 200)";
								}
								else if(d.Label == 1) {
									return "rgb(0, 200, 0)";
								}
								else if(d.Label == 2) {
									return "rgb(200, 0, 0)";
								}
								else if(d.Label == 3) {
									return "rgb(200, 200, 0)";
								}
								else if(d.Label == 4) {
									return "rgb(200, 0, 200)";
								}
								else if(d.Label == 5) {
									return "rgb(0, 200, 200)";
								}
						})
						.style("opacity", "0.8")
						.attr("stroke", "grey")
						.attr("stroke-width", "0.2")
					  d3.selectAll('#mean').style("visibility", "visible")
					  d3.selectAll('#mean').moveToFront()
					    .style("opacity", 1)
					dots.exit()
						.remove()
				}				
			})
			d3.selectAll("div")
			.on("mouseover", function() {
			var divID = d3.select(this).attr("id");
			
				if (divID == "k2") {
					var mean_file = mean_file_k2;
					var data_file = data_file_k2;
				}
				else if (divID == "k3") {
					var mean_file = mean_file_k3;
					var data_file = data_file_k3;
				}
				else if (divID == "k4") {
					var mean_file = mean_file_k4;
					var data_file = data_file_k4;
				}
				else if (divID == "k5") {
					var mean_file = mean_file_k5;
					var data_file = data_file_k5;
				}
				else if (divID == "k6") {
					var mean_file = mean_file_k6;
					var data_file = data_file_k6;
				};
				
				function call_obs(){
					//Add dots for the observations
					d3.csv(data_file, function(data_csv	){
						addObs(data_csv);
					});		
				}
				//Add circles for the K means
				d3.csv(mean_file, function(mean_csv){
					addMeans(mean_csv);	
					call_obs();
				});							
				
				function addMeans(mean_csv){
					var circles = svg.selectAll("circle")	//Select all circles
						.data(mean_csv) 					//Re-bind data to existing circles, return the 'update' selection
				 circles.transition()
						.attr("id", "mean2")
						.attr("cx", function(d) {
							return projection([d.lon, d.lat])[0];
						})
						.attr("cy", function(d) {
							return projection([d.lon, d.lat])[1];
						})
						.attr("r", "8")
						.style("stroke", "black")
						.attr("stroke-width", "2.5")
						.style("fill", function(d) {
								if(d.Label == 0) {
									return "rgb(0, 0, 200)";
								}
								else if(d.Label == 1) {
									return "rgb(0, 200, 0)";
								}
								else if(d.Label == 2) {
									return "rgb(200, 0, 0)";
								}
								else if(d.Label == 3) {
									return "rgb(200, 200, 0)";
								}
								else if(d.Label == 4) {
									return "rgb(200, 0, 200)";
								}
								else if(d.Label == 5) {
									return "rgb(0, 200, 200)";
								}					
						})
						.style("opacity", 0.5)
					  d3.selectAll('#mean').style("visibility", "hidden")

				}		

				function addObs(data_csv){
					var dots = svg.selectAll("dot")	//Select all dots
						.data(data_csv); 				//Re-bind data to existing dots, return the 'update' selection
					dots.enter()						
						.append("circle")
						.attr("id", "obs2")
						.attr("cx", function(d) {
							return projection([d.X_input, d.Y_input])[0];
						})
						.attr("cy", function(d) {
							return projection([d.X_input, d.Y_input])[1];
						})
						.attr("r", "1.0")
						.style("fill", function(d) {
								if(d.Label == 0) {
									return "rgb(0, 0, 200)";
								}
								else if(d.Label == 1) {
									return "rgb(0, 200, 0)";
								}
								else if(d.Label == 2) {
									return "rgb(200, 0, 0)";
								}
								else if(d.Label == 3) {
									return "rgb(200, 200, 0)";
								}
								else if(d.Label == 4) {
									return "rgb(200, 0, 200)";
								}
								else if(d.Label == 5) {
									return "rgb(0, 200, 200)";
								}								
						})
					  
						.style("opacity", 0.5)
					  d3.selectAll('#obs').style("visibility", "hidden")
					  d3.selectAll('#mean2').moveToFront()
				}				
			})
			d3.selectAll("div")
			.on("mouseout", function() {
			var divID = d3.select(this).attr("id");
				d3.selectAll('#mean2').remove()
				d3.selectAll('#obs2').remove()	
				d3.selectAll('#mean').style("visibility", "visible")
				d3.selectAll('#obs').style("visibility", "visible")					
			})
			
        </script>
</body>
</html>